---
title: "Feather Wallet - Отчет об инциденте: Отказ в обслуживании"
date: "2024-05-01"
categories:
  - "Новости"
tags:
  - "Feather Wallet"
thumbnail: ""  
lead: "Feather Wallet версии 2.6.5 и ниже больше не может отправлять транзакции. Обновите Feather Wallet до версии 2.6.6 или новее, чтобы устранить эту проблему"
pager: true
toc: true
sidebar: "right"
widgets:
  - "recent"
  - "taglist"
---

## _Резюме_

**Feather Wallet версии `2.6.5` и ниже больше не может отправлять транзакции. Обновите Feather Wallet до версии `2.6.6` или новее, чтобы устранить эту проблему**.

Пользователи, пытающиеся создать транзакцию в версии `2.6.5` и ниже, получают следующее сообщение об ошибке: _"Внутренняя ошибка: Ошибочное количество выходов в распределении выходов"_.

![1](/img/post/2024-05-01-feather-wallet-incident-report-denial-of-service/01.png)

Ошибка возникла, когда количество выходов RingCT в блокчейне превысило отметку в 100 миллионов. Это привело к ошибке при создании транзакций, показанной выше.

В течение примерно 5 часов 28 апреля 2024 года все доступные версии были затронуты ошибкой, что фактически не позволяло никому переводить средства с помощью Feather Wallet в течение всего этого времени.

## _Причина возникновения ошибки_

29 августа 2021 года я [разместил патч](https://github.com/feather-wallet/monero/commit/f5b91c6b) под названием 'Проверка распределения выходов' в форке Feather в основной библиотеке кошелька Monero. Этот патч был впервые включен в бета-версию Feather beta-9, которая была выпущена 16 сентября 2021 года.

Цель этого патча - обеспечить более эффективную защиту от атаки, известной как "распределение отравленных выходов".

Распределение выходов представляет собой гистограмму выходов RingCT и влияет на то, как кошелек выбирает приманки для колец. Когда создается транзакция, кошелек запрашивает распределение выходов у узла, к которому он подключен.

В ходе атаки вредоносный удаленный узел манипулирует распределением выходов таким образом, чтобы с высокой степенью вероятности узнать истинные траты. Один из способов, которым узел может это сделать, притвориться, что в блокчейне значительно больше выходов, чем есть на самом деле. Это заставляет приманки отклоняться в сторону "нереального" числа, на которые ссылается их глобальный индекс.

Рассмотрим следующий набор выходных индексов, представляющих собой кольцо, для которого кошелек запрашивает у узла соответствующие публичные ключи:

`{99655570, 50001410564, 50001585151, 50001818442, 50001853725, ...}`

Узел может четко определить, что первый выход - это реальная трата, потому что это единственный "реальный" выход, который существует в блокчейне.

Это может позволить узлу связать выход с IP-адресом. Обратите внимание, что по умолчанию Feather ретранслирует транзакции через Tor, поэтому единственная информация, которую может узнать узел, это то, что кто-то, используя Tor, в настоящее время пытается потратить этот выход. По умолчанию Feather подключается к узлу из списка узлов, управляемых участниками сообщества. Если узел из этого списка окажется вредоносным, он может быть быстро удален, а его оператор добавлен в черный список.

При таком наивном подходе транзакция будет отклонена сетью, поскольку кольцо содержит недопустимые индексы. Пользователь получил бы сообщение об ошибке при передаче транзакции и быстро переключился бы на другой узел.

Более изощренный злоумышленник может представить распределение выходов таким образом, чтобы выбор приманки был смещён так, что истинная трата будет обнаружена, но распределение ложных выходов не приведет к недействительной транзакции.

Например, эта транзакция была построена с использованием манипулируемого выходного распределения. Можете ли вы определить, какова истинная трата? Обратите внимание, что все участники кольца старше 1 года и 200 дней, за исключением одного выхода 6-дневной давности. Если пользователь не проверит кольцо в блокчейн-обозревателе и не будет знать, на что обращать внимание, он не заметит, что его транзакции подвергаются подобной дактилоскопии.

Еще более хитрые злоумышленники могут дать вредоносному узлу лишь статистическое преимущество, позволяющее угадать истинную сумму траты, но не заметить отпечаток транзакции на цепочке для случайного наблюдателя.

Патч пытался смягчить эту атаку с помощью двух проверок:

1. Он хэширует выходное распределение, возвращаемое узлом до высоты контрольной точки, и сравнивает его с жестко закодированным хэшем. Если хэши не совпадают, возвращается ошибка. Это предотвращает любую фальсификацию распределения до высоты текущей контрольной точки.
2. Проверяется, не превышает ли общее количество выходов в распределении заданный предел. Именно эта "проверка на корректность" в конечном итоге и привела к тому, что построение транзакций было ошибочным, когда реальное количество выходов в блокчейне превысило этот предел.

При дальнейшем рассмотрении первая проверка оказывается эффективной мерой, если она обновляется с каждым релизом. Она ограничивает возможности злоумышленников по выбору приманки. Вторая проверка кажется неэффективной, так как проинформированный злоумышленник все равно может сместить распределение чуть ниже предела. Она могла бы поймать только злоумышленника, который не знал о подобном ограничении.

Изначально я заявил, что "большое количество выходов было добавлено в прошлом месяце в результате спам-атаки", полагая, что патч был более поздним изобретением, и думал, что спам-атака внесла более существенный вклад в ускорение сроков. Проанализировав информацию, я обнаружил, что атака внесла в цепочку выходов смещение всего лишь на ~2,5 месяца. Более того, возможность такой атаки должна была быть принята во внимание при рассмотрении вопроса о том, стоит ли вообще вводить такое ограничение.

* На момент выхода патча (август 2021 г.) в блокчейне Monero существовало около 48,8 миллиона выходов RingCT. Лимит был установлен в 100 миллионов.
* Предел и жестко закодированный хеш никогда не обновлялись по сравнению с их первоначальными значениями.
* К 3 марта 2024 года, к началу мартовской спам-атаки, количество выходов RingCT в блокчейне Monero уже выросло до 90,8 миллиона.
* Согласно исследованию Rucknium, спам-атака добавила около 4,62 или 4,71 миллиона выходных данных в зависимости от того, какое определение используется для спам-транзакций.
* Обновление лимита или жестко закодированного хеша не было задокументировано в информации релиза, и их значение не отслеживалось. Информация про данные лимиты была задокументирована именно для того, чтобы предотвратить подобное, но была добавлена в примечания релиза только в январе 2023 года. К тому времени о существовании патча, видимо, уже не вспоминали.
* 28 апреля 2024 года был найден блок 3137429, в результате чего количество выходов RingCT превысило лимит в 100 миллионов, что привело к сбою во время построения транзакции.

На повестке дня стояли планы по очистке набора патчей Feather с целью "максимально возможного живого обновления". Я считаю, что снял бы это ограничение, если бы работал над этим раньше, но, очевидно, этого не произошло до того, как ограничение было достигнуто. После взлома CCS кошелька я отдал весь приоритет текущей задаче по обеспечению непрерывности работы CCS, которая включала в себя завершение работы по созданию оффлайн-транзакций с помощью анимированных QR-кодов и текущую работу по интеграции multisig. Что, в свою очередь, привело к задержкам в обслуживании.

Я пришел к выводу, что проверку на корректность не следовало добавлять и что моя неспособность должным образом документировать, контролировать и поддерживать патч в конечном итоге привела к отказу в обслуживании.

## _График реагирования на происшествие_

### _2.6.6_

`20:40` - Пользователь `miracloe` присоединяется к irc-каналу и первым сообщает, что столкнулся с сообщением об ошибке.
`20:46` - Я смог воспроизвести сообщение об ошибке, попытавшись отправить тестовую транзакцию.

Чтобы предотвратить это в будущем, проверка на корректность была удалена.

`21:41` - Релиз `2.6.6` отмечен тегом и начинается процесс сборки.
`00:04` - Сборки завершены и переданы на устройство для подписания релизов.
`00:13` - Сборки подписаны и начинается загрузка.
`01:15` - Загрузка завершена, релиз доступен на веб-сайте и во встроенном инструменте обновления кошелька.

![2](/img/post/2024-05-01-feather-wallet-incident-report-denial-of-service/02.png)

**'Report to Tag'** - это время, которое потребовалось для воспроизведения, отладки и устранения проблемы.
**'Tag to Release'** - это время, которое потребовалось для выпуска обновления, включающего сборку, подписание и загрузку релиза, а также обновление веб-сайта.

Для большинства пользователей на этом ожидание завершилось, другим пришлось ждать релиза `2.6.7`.

### _2.6.7_

01:49 - Пользователь `rayven123` сообщает в irc-канале, что не может открыть `2.6.6` на Tails 5.
01:57 - Я смог воспроизвести проблему, попытавшись открыть `2.6.6` на Tails 5.

Оказалось, что эта проблема связана с обновлением компилятора и не имеет отношения к исправлению проблемы с распределением выходов. Она существовала в мастер-ветке с 18 марта, но осталась незамеченной, поскольку проблема не затрагивала мой компьютер для разработки.

Поскольку все версии до `2.6.5` больше не могли отправлять транзакции, а `2.6.6` не запускалась на некоторых Linux-системах, потребовался новый релиз.

В этот период несколько других пользователей сообщили, что не могут запустить `2.6.6` на различных дистрибутивах Linux, включая Whonix и Fedora 40. Еще один пользователь сообщил о проблеме с многоцелевыми транзакциями, отладка которой заняла некоторое время, но в итоге проблема не была связана с релизом.

`04:37` - Релиз `2.6.7` отмечен тегом и начинается процесс сборки.
`04:50` - Измотанный я сообщаю, что отправляюсь спать всего на несколько часов.
`08:18` - Я просыпаюсь и начинаю загружать релизы.
`08:48` - Релиз `2.6.7` теперь доступен на веб-сайте и во встроенном инструменте обновления кошелька.

![3](/img/post/2024-05-01-feather-wallet-incident-report-denial-of-service/03.png)

## _Проверка воспроизводимости после релиза_

Для типичных релизов не менее двух человек должны предоставить подписанный список хэшей, называемый [аттестацией](https://github.com/feather-wallet/feather-sigs). Это делается для проверки [воспроизводимости сборок](https://dl.gi.de/server/api/core/bitstreams/f8685808-2e51-4a53-acc0-2b45fa240e3b/content). Если релиз не воспроизводим, процесс выпуска не может быть завершен; все источники проблем должны быть устранены, а новый релиз должен быть отмечен тегом.

Для подобного экстренного релиза нет времени ждать подтверждения от нескольких человек. Поэтому данное требование было снято для `2.6.6` и `2.6.7`.

К счастью, оба релиза были проверены на воспроизводимость после релиза. На момент написания статьи `2.6.6` была собрана `plowsof` и мной, а `2.6.7` - `plowsof`, `MoneroArbo` и мной, причем все хэши совпали.

В связи с этим возникает вопрос, что бы произошло, если бы сборки оказались невоспроизводимыми после релиза?

В случаях, например, когда недетерминизм тривиально объясняется доброкачественным источником вроде встроенной временной метки, исправление может быть опубликовано в [ERRATA.md](https://github.com/feather-wallet/feather-sigs/blob/main/ERRATA.md). Этот документ был введен после версии `2.6.5`, которая содержала проблему со скриптом аттестации.

Для описания проблемы можно использовать инструмент типа `diffoscope`, показывающий двоичную разницу между двумя сборками. Это дает валидаторам сборок уверенность в том, что релиз был собран именно из его исходного кода.

Если двоичная разница слишком сложна для описания в исправлении, следует выводить предупреждение и немедленно отозвать релиз после появления новой версии.

## _Извлеченные уроки_

### _О проверках на корректность_

Главный вывод - никогда не добавляйте проверки, которые могут не сработать в определенное время или в будущем, особенно если это может помешать корректной работе основных функций кошелька. Насколько мне известно, в последней версии таких проверок нет.

Хотя проверка на корректность не входила в мои планы, я считаю, что может быть полезно иметь встроенную "дату истечения срока годности" для релиза. Новые релизы содержат исправления ошибок, улучшают конфиденциальность и безопасность, а также устраняют уязвимости (в Feather, Monero или любой из их статически связанных зависимостей). Важно, чтобы пользователи постоянно обновляли программное обеспечение.

Если с момента релиза прошло определенное количество времени (например, 1 год), можно вывести предупреждение и предложить пользователю подумать об обновлении. Пользователь может скрыть предупреждение и продолжать пользоваться кошельком, если по каким-то причинам не хочет обновляться.

### _Об экстренных релизах_

Это был первый экстренный релиз в истории Feather.

Экстренные релизы предназначены для двух сценариев:

* Устранение критической уязвимости, которая может привести к потере средств.
* Отказ в обслуживании основных функций кошелька (отправка и получение), который затрагивает последнюю версию Feather по крайней мере на одной из основных платформ.

Иногда возникает необходимость в "быстрых" релизах. Например, `2.6.3`, в котором была исправлена проблема, не позволявшая Feather корректно работать на Tails 6, или `2.6.4`, в котором была исправлена автоматическая корректировка комиссии во время вышеупомянутой спам-атаки. В обоих случаях было ощущение срочности, но проблемы не были достаточно серьезными, чтобы претендовать на статус срочного релиза. Экстренные релизы по-прежнему должны соответствовать [процедуре выпуска](https://github.com/feather-wallet/feather/blob/master/RELEASE.md), но могут быть выпущены "на лету", когда возникает подобная ситуация.

Экстренный релиз должен включать _только_ критическое исправление и, возможно, другие важные исправления, которые ожидались в следующем релизе.

Это минимизирует вероятность появления новых ошибок. Обычные релизы тестируются перед тем, как их отметят тегом, чтобы проверить, не создает ли полный набор изменений новые проблемы. Хотя это должно происходить и в случае экстренного релиза, чтобы убедиться, что исправление действительно работает, времени на тестирование всех ожидающих изменений не хватает.

В случае, если изменения в системе сборки или обновления пакетов должны были войти в следующий релиз, это также минимизирует вероятность внесения недетерминизма в процесс сборки.

К сожалению, я принял решение выпустить аварийный релиз `2.6.6` на основании master-ветки, а не на `2.6.5`. Релиз `2.6.6` содержал 20 новых коммитов, в отличие от релиза `2.6.5`, которые, за исключением критического исправления, ожидали аудита для следующего релиза и включали изменения системы сборки, исправления в выборе приоритета, а также новую функцию, которую я недавно протестировал.

[Критическое исправление](https://github.com/feather-wallet/monero/commit/376fb747ea262cf6cd773cc169bbd3e84670d733) удалило три строки кода (включая пустую строку и комментарий). Если бы было включено только это исправление, другим было бы проще сравнить исходный код `2.6.5` и `2.6.6` и быть уверенными, что аварийный релиз не был использован как возможность внедрить вредоносный код в исходный код.

Изменения в системе сборки в итоге привели к ошибке, из-за которой потребовался второй экстренный релиз и которая также могла легко вызвать недетерминизм. Если в будущем возникнет необходимость в экстренном релизе, я больше не допущу подобной ошибки. К положительным моментам можно отнести то, что в `2.6.6` были внесены изменения комиссии, о которых так давно просили пользователи.

### _О процедуре выпуска_

Давайте разберем, сколько времени занял каждый этап процедуры выпуска `2.6.6`, и обсудим, как его можно оптимизировать.

![4](/img/post/2024-05-01-feather-wallet-incident-report-denial-of-service/04.png)

![5](/img/post/2024-05-01-feather-wallet-incident-report-denial-of-service/05.png)

Общий размер артефактов для любого релиза составляет порядка 1000 МБ. Подписанные хэшлисты и подписи занимают всего 150 КБ.

Для сохранения анонимности все релизы загружаются через Tor на веб-сервер со специальной «машины для загрузки». Загрузка данных объемом в гигабайты через Tor может занять некоторое время, а скорость загрузки может сильно различаться. Загрузка версии `2.6.6` заняла более часа, а версии `2.6.7` «всего» 30 минут. Если производительность сети Tor снизится, загрузка релиза может занять часы или дни. Очевидно, что в сценариях, где время необходимо свести к минимуму, любое дополнительное промедление нежелательно.

Когда релиз отмечен, задание GitHub CI начинает его сборку. Благодаря воспроизводимым сборкам артефакты, созданные GitHub, будут постепенно соответствовать локальным сборкам (если только не был добавлен какой-то источник недетерминизма).

На завершение сборки у задачи CI ушло 2 часа 20 минут, что занимает примерно столько же времени, сколько мне нужно на локальную сборку. Несмотря на небольшое количество потоков, доступное для исполнителей GitHub, и отсутствие кэширования (из-за ограничений хранилища), распараллеливание дает большие преимущества за счет создания каждой цели на отдельном потоке. В то время как локальные сборки являются последовательными, то есть одна точка собирается за другой. Еще момент, когда локальный процесс сборки не может использовать все доступные ядра (например, на этапах настройки пакета), он значительно проигрывает варианту с параллельной сборкой.

![6](/img/post/2024-05-01-feather-wallet-incident-report-denial-of-service/06.png)

Большая часть времени тратится на восстановление данных, которые могли быть кэшированы. Мы сможем уместить все кэшированные данные в пределах лимита кеша GitHub в 10 ГБ, если будем хранить кеши только для последнего тега. При кэшировании нижняя граница равняется 20 – 44 минутам.

Мы не можем полагаться исключительно на GitHub при сборке, поэтому необходимо также разработать способ распараллеливания локальных сборок. Даже обычные выпуски выиграют от этого.

### _О коммуникации_

Информация об инциденте могла бы быть донесена до пользователей более эффективно.

Вот где можно было разместить подобную информацию:
* Уведомление на сайте / RSS-канале
* Описание канала в irc/matrix
* Отдельный issue на GitHub
* Пост на [monero.town](https://featherwallet.org/changelog/monero.town) и X

У меня не было автоматизированного способа быстро опубликовать информацию по этим каналам, и я не хотел тратить время, поэтому я не размещал информацию везде, где только мог. Скрипт на «машине загрузки» мог бы позаботиться о публикации короткого сообщения по всем указанным выше каналам, поэтому я поработаю над его реализацией.

Спасибо SummerBreeze за создание темы на monero.town и x011 за создание issue на GitHub во время данного инцидента.

---

_Источник: [ncident report: Denial-of-Service (28 April 2024)](https://featherwallet.org/changelog/)_

_Перевод: [Mr. Pickles](https://t.me/v1docq47)_  
_Коррекция: [Kukima](https://t.me/Kukima)_
