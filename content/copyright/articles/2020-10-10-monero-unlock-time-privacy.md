---
title: "Проблемы с временем разблокировки Monero"
date: "2020-10-10"
categories:
  - "Статьи"
tags:
  - ""
lead: "В этой последней статье из серии, состоящей из трёх постов, посвящённых времени разблокировки (unlock_time) в Monero, я пытаюсь вникнуть в проблемы, связанные с анонимностью при использовании текущего времени разблокировки, и в то, как можно улучшить ситуацию, зашифровав поле, ограничив его содержимое, настроив возможность выбора участников кольца или полностью удалив всё разом."
pager: true
toc: true
sidebar: "right"
---

В последних двух постах (пожалуйста, прочтите сначала их) подробно описаны как уязвимости в [реализации [1]](https://thecharlatan.ch/Wallet-Timelock), так и [в протоколе [2]](https://thecharlatan.ch/Monero-Unlock-Time-Vulns) поля unlock_time транзакций Monero как для приложений, которые должны верифицировать это поле, так и для основного программного обеспечения Monero. Исследования, проведённые в январе 2020 года специалистом в области обработки данных, Isthmus (в Twitter известным как [@Mitchellpkt0](https://twitter.com/Mitchellpkt0)), из Исследовательской лаборатории Monero (#monero-research-lab - IRC-канал на Freenode, который делает обсуждение исследований проще), показали, что параметр unlock_time также не до конца понятен и для многих пользователей Monero. Его использование оставляет информационные следы, которые могут нанести ущерб анонимности пользователей. После публикации соответствующей информации в последних двух статьях в конце апреля этого года мною было написано предложение по внедрению шифрования времени разблокировки, которое позволило бы решить эту проблему, связанную с нарушением анонимности. Тогда это предложение не особо поддержали по причинам, которые я раскрою ниже, и я не стал добиваться его реализации. Части того предложения, соавтором которых стал Isthmus, переработаны в рамках данной статьи. Также я выражаю благодарность коллеге Isthmus, N3ptune, предоставившему необработанные данные.

## _Шаблоны использования unlock_time_

Анонимность Monero во многом зависит от неразличимости транзакций, которая не позволяет связывать транзакций друг с другом. Любая характеристика транзакции, раскрывающая что-либо о пользователе или программном обеспечении, которое её создало, снижает уровень анонимности. Одним из примеров может служить статистический анализ времени разблокировки, при котором происходит разделение анонимного пула Monero в зависимости от программного обеспечения и пользователя, создавших транзакцию. Данные, представленные в настоящей статье, были взяты из блоков с 1 000 000 по 2 197 574.

Было выявлено примерно пять разных шаблонов использования параметра unlock_time:

1. unlock_time = 0

- Поведение основного кошелька (и любого другого кошелька, удачно имитирующего его) по умолчанию.
- Выход, который можно потратить в генезис-блоке, никогда не блокируется.
- Было зарегистрировано только 12 493 транзакции, где значение параметра было задано выше
- Пример: [e4098567e981e9596f8b2a449c7df24cc77268ff08280b5901b624c2de234202​](https://localmonero.co/blocks/search/e4098567e981e9596f8b2a449c7df24cc77268ff08280b5901b624c2de234202)

---

2. unlock_time = {1 … 6, 10, 12, 13, 15}

- Эти низкоцелочисленные значения unlock_time не имеют семантического смысла, поэтому намерения разработчика неясны. Возможно, он хотел, чтобы время блокировки было относительным, а не абсолютным, или же поле используется для чего-то еще, не связанного с временем разблокировки.
- В общей сложности в 12 297 транзакциях, примерно 98% случаев использования параметра unlock_time
- Пример: [bf800d30889423fafdf7cde841f1a61d3372667a0efc7c6e8784f220c0dcc3a8](https://localmonero.co/blocks/search/bf800d30889423fafdf7cde841f1a61d3372667a0efc7c6e8784f220c0dcc3a8)

---

3. unlock_time ~ 1 000 000+

- Значение unlock_time менее 500 000 000 интерпретируется как высота блока
- 195 транзакций, примерно 2% от всех случаев использования параметра unlock_time на данный момент
- Пример: [93df46c18742ff6fd0ba86076bd360b0a32cda4f670b9944c9f176d5c9783959](https://localmonero.co/blocks/search/93df46c18742ff6fd0ba86076bd360b0a32cda4f670b9944c9f176d5c9783959)

---

4. unlock_time ~ 1 400 000 000

- Большое значение unlock_time означает время Unix
- Никаких транзакций в этом диапазоне не зафиксировано!
- Пример: [012932593e59f21d10b7badc5f0556c1aaaefd60d0ebf05f1637361a66b17273​](https://localmonero.co/blocks/search/012932593e59f21d10b7badc5f0556c1aaaefd60d0ebf05f1637361a66b17273)

---

5. unlock_time > 1 400 000 000 000

- Теоретически эти выходы будут разблокированы в далёком будущем
- Единственная транзакция со значением 1844674073709551616 [была создана Isthmus](https://twitter.com/Mitchellpkt0/status/1251621277179146240), и она заблокирована до 292 277 026 596 года.
- Пример: [2c2762d8817ea4d1cb667752698f2ff7597a051d433043776945669043d908b5​](https://localmonero.co/blocks/search/2c2762d8817ea4d1cb667752698f2ff7597a051d433043776945669043d908b5)

Isthmus также подготовил следующий график использования unlock_time (ещё два приводятся ниже):

![01](/img/copyright/articles/2020-10-10-monero-unlock-time-privacy/01.png)

Распределение использования низких значений представляется странным (в верхнем ряду указаны значения unlock_time, в нижнем ряду - количество случаев использования):

![02](/img/copyright/articles/2020-10-10-monero-unlock-time-privacy/02.jpg)

У меня есть два объяснения такого поведения: либо кто-то забыл добавить текущую высоту блока поверх желаемого количества заблокированных блоков, либо неправильно использует поле для передачи дополнительной информации.

Особенные шаблоны, такие как эти с низкими значениями, дают возможность связывания транзакций. Могут быть деанонимизированы и иным образом затронуты не только отправитель и получатель, но и любой другой пользователь, выбравший эти выходы в качестве миксинов для своей подписи. При использовании схемы обеспечения анонимности на основе ложных выходов пользователь не может отрицательно повлиять на уровень приватности, не затронув при этом других.

Следующая гистограмма наглядно показывает, насколько использование параметра unlock_time соответствует этим нелогичным шаблонам и насколько мала в них доля разумных значений (обведены синим кружком):

![03](/img/copyright/articles/2020-10-10-monero-unlock-time-privacy/03.png)

Monero — не единственная криптовалюта, в которой из-за беспорядочного использования параметра unlock_time случаются утечки информации. В случае с другими анонимными монетами блокировка по времени использовалась даже для стеганографии (см. [эту ветку](https://twitter.com/f2pool_official/status/1246154346481381378)).

На следующем графике продемонстрирована разница между значимой высотой блока unlock_time и высотой его вычисления (майнинга), что отражает фактическое количество блоков, на которое заблокирована каждая транзакция:

![04](/img/copyright/articles/2020-10-10-monero-unlock-time-privacy/04.png)

Я не нашёл объяснения выявленным шаблонам использования. Я ожидал увидеть горизонтальные линии, созданные сервисами, использующими эту функцию, чтобы задавать определенное количество блоков. Вместо этого появились вертикальные шаблоны и наклонный кластер после высоты блока 2 000 000.

## _Параметр unlock_time и выбор участников кольца_

Помимо этих кластеров, ещё одну проблему для анонимности пользователей представляют транзакции со значимым параметром unlock_time. В случае с Monero в качестве ложных участников кольцевых подписей выбираются выходы прошлых транзакций, которые хранятся в блокчейне Monero. Процесс выборки должен имитировать поведение при трате выходов. Пользователи, как правило, тратят более «молодые» выходы чаще, чем старые, поэтому при выборке предпочтение отдаётся транзакциям, созданным на большей высоте блока, а не на низкой. Однако при выборке значения параметр unlock_time не вычисляется сверх фактической высоты блока. Предположим, что текущая высота блока составляет 400 000. В соответствии с действующими на данный момент правилами выход со значением unlock_time 350 000, созданный на высоте блока 200 000, обрабатывается так же, как и другой выход, созданный на высоте 200 000, даже если выход со значением unlock_time будет доступен для траты только через 50 000 блоков, в то время как другой выход можно будет потратить через 200 000 блоков. Данное слабое место в алгоритме выбора приводит к утечке информации, позволяя наблюдателю за блокчейном Monero угадать, какой из участников кольцевой подписи является ложным, а кто реальным.

Решение заключается в том, чтобы учитывать статистическое поведение при выборе по возрасту, связанное с unlock_time, подбирая ложных участников кольца. Возраст траты позволят измерить количество времени, которое проходит между "созреванием" выхода транзакции и его последующим использованием в качестве входа транзакции. Статистические данные о возрасте траты могут быть взяты из прозрачного блокчейна, использующего блокировку по времени, например, из блокчейна Bitcoin, а затем их можно задействовать для эвристического анализа Monero. Данное упущение в алгоритме выбора в настоящее время не представляет собой проблемы, поскольку параметр unlock_time почти не используется.

## _Шифрование блокировки по времени_

Грубым решением могло бы стать полное удаления поля. Используется оно редко, но при этом может стать причиной утечки информации. Как вариант, добавление временной блокировки для каждого выхода и ограничение размера поля до более компактного типа данных, например, время шифрования 2-байтового числа с шагом в час и 1-битным флагом для выбора, в зависимости от блока или времени, может значительно уменьшить вероятность вредоносного использования. Кроме того, транзакции с ненулевой блокировкой по времени, которые были созданы в прошлом, могут быть заблокированы в соответствии с правилами консенсуса.

Более изощрённый подход — это реализация зашифрованных параметров блокировки по времени, которые бы не допускали утечки информации, следов пользователя / программного обеспечения, поскольку шифротекст распределяется равномерно. Значения временной блокировки могут быть зашифрованы аналогично тому, как на этот момент происходит шифрование суммы Monero. Обязательство по нулевой сумме, доказывающее то, что время блокировки истекло, просто добавляется к существующей конструкции кольцевой подписи. Также необходимо представить доказательство Bulletproof для значения временной блокировки в целочисленном диапазоне. Суть этих дополнительных этапов шифрования описана в публикации [№65 Исследовательской лаборатории Monero](https://github.com/monero-project/research-lab/issues/65) и работе по [DLSAG](https://eprint.iacr.org/2019/595.pdf).

![05](/img/copyright/articles/2020-10-10-monero-unlock-time-privacy/05.png)

Зашифрованные параметры временной блокировки имеют серьезные недостатки с точки зрения производительности. Помимо значительно увеличивающегося (примерно в 2 раза) времени верификации как в случае с используемым в настоящее время, так и возможным будущим алгоритмом, шифрование также требует дополнительных 64 байта на подпись в транзакции и 32 байта на каждый дополнительный выход, связанный с блокировкой по времени, если она реализуется поверх алгоритма подписи CLSAG. Также возможно значительное увеличение как размера, так и времени верификации доказательства диапазона. Оптимальная схема доказательства диапазона пока ещё не найдена, поэтому нет и конкретных цифр, связанных с воздействием на производительность доказательств диапазона.

Из-за этих недостатков, связанных с производительностью и нечастым использованием параметра unlock_time пользователями Monero, и не было проявлено особого энтузиазма в отношении шифрования временной блокировки.

## _Заключительные замечания_

Подведём итоги и перечислим выявленные проблемы: параметр unlock_time был реализован с ошибками, которые, похоже, разработчики упускают из виду, чем наносят ущерб анонимности пользователей Monero. Кроме того, использовать его сложно или даже опасно. Он блокирует всю транзакцию, а не отдельные выходы. При заданном параметре любая Monero в сдаче или любом другом выходе получателя также блокируется!

Я считаю маловероятным наличие каких-либо других недостатков, помимо удвоения размера и времени верификации, при шифровании временной блокировки. До сих пор принцип разработки Monero состоял в отсутствии каких-либо компромиссов в отношении обеспечения самых высоких параметров анонимности и безопасности пользователей по умолчанию. Я считаю, что, если Monero стремится сохранить свой статус доминирующей криптовалюты, ориентированной на обеспечение анонимности, издержки, связанные с производительностью, не должны сказываться на возможности повышения уровня анонимности и безопасности. Однако такой масштаб технической работы кажется слишком большим в сравнении с небольшим объёмом использования параметра unlock_time. На мой взгляд, лучше всего просто полностью удалить его.

---

_Источник: [Monero timelock woes](https://thecharlatan.ch/Monero-Unlock-Time-Privacy/)_

_Перевод: [Mr. Pickles](https://t.me/v1docq47)_  
_Коррекция: [Kukima](https://t.me/Kukima)_
