---
title: "Раскрытие уязвимости: анализ ошибки выбора ложных выходов возрастом 10 блоков"
date: "2023-05-23"
categories:
  - "Статьи"
tags:
  - ""
lead: ""
pager: true
toc: false
sidebar: "right"
---

### _Краткие факты_

- Серьезность угрозы: высокая.
- Уязвимые версии: версии GUI/CLI кошельков, начиная с v0.13.0.2 по v0.18.2.1.
- Возможные последствия: утрата анонимности отправителя транзакций, в которых будут отправляться выходы возрастом ровно 10 блоков.
- Что делать: обновить кошельки до версии v0.18.2.2.

### _Введение_

Когда кошельку Monero нужно построить транзакцию с определённым выходом, он также выбирает в блокчейне ложные выходы, используя определённый механизм распределения, называемый «гамма-распределением». Гамма-распределение делает выбор недавних ложных выходов более вероятным, чем выбор более старых, имитируя реальную трату средств пользователями. Однако в коде гамма-распределения была обнаружена ошибка, которая не позволяла выбирать ложные выходы, возраст которых составлял ровно 10 блоков. При этом кошелёк всё равно позволял тратить принадлежащие ему выходы, возраст которых был равен 10 блокам. Это означало, что внешний наблюдатель мог с очень высокой степенью вероятности угадать выход, который реально тратился при построении кольца, если возраст одного из участников такого кольца был равен 10 блокам.

Эта ошибка была исправлена в версии 0.18.2.2, и всем пользователям рекомендуется как можно скорее обновить свои кошельки. Поскольку в основе многих сторонних кошельков лежит базовый код wallet2, если вы не пользуйтесь CLI/GUI кошельками Monero Core, вам следует поинтересоваться у команды разработчиков вашего кошелька, был ли он обновлён до новой версии кода wallet2. Обновление вашего кошелька до версии v0.18.2.2 не только повысит уровень анонимности отправителя, но и увеличит размер анонимного пула для всех остальных пользователей, включая тех, кто использует старый и уязвимый код кошелька. Если же вы вынуждены пользоваться старой версией кошелька, никогда не тратьте средства сразу после их разблокировки — перед отправкой обязательно подождите один дополнительный блок.

### _Техническое объяснение_

_**Более глубокое погружение в проблему**_

_Большая часть приводимого ниже текста скопирована непосредственно из статьи "[Анализ ошибок, связанных с выбором ложных выходов](https://www.getmonero.org/2021/09/20/post-mortem-of-decoy-selection-bugs.html)", опубликованной [@j-berman](https://github.com/j-berman) в 2021 году._

Алгоритм выбора ложных выходов предназначен для выбора из блокчейна выходов на основе наблюдаемых моделей трат, как было рекомендовано в работе [Мозера и др](https://arxiv.org/pdf/1704.04299/). При анализе, описанном в статье, для достижения распределения шаблонов трат, совершаемых пользователями Monero, использовались модели трат из ранних версий Monero, где в некоторых случаях можно было с уверенностью определить реальные выходы, использованные в транзакциях. В статье подчёркивалось, что пользователи чаще тратили средства, полученные относительно недавно, чем средства, хранившиеся у них в течение длительного времени. В статье рекомендовалось учитывать наблюдаемую динамику расходов при выборе выходов из блокчейна для их последующего использования в качестве ложных, а не применять равную вероятность ко всему набору выходов, находящихся в блокчейне. Таким образом, в качестве ложных с наибольшей вероятностью будут выбраны более новые выходы, а не более старые, что позволит лучше скрыть, какой выход является реальным в транзакциях пользователей.

Когда эта рекомендация была впервые реализована в версии [v0.13.0.0](https://github.com/monero-project/monero/pull/3528) Monero, кошелёк правильно применил наблюдаемый паттерн расходов, выбрав ложные выходы с вершины блокчейна. Однако когда алгоритм был обновлен в версии v0.14.1.0, он стал применять наблюдаемую модель расходов, начиная с 10 последних блоков и до вершины блокчейна. Это было сделано потому, что выходы моложе 10 блоков блокировались и их нельзя было потратить, поэтому казалось логичным применять распределение, начиная с 10 блоков и до вершины блокчейна. В результате учитывались только те выходы, которые можно было потратить.

_**Ошибка завышения на единицу**_

Перед тем как выбрать ложные выходы для новой транзакции, кошелёк с помощью RPC-команды /get_output_distrubution.bin использует интегральную функцию распределения выходов по блокам из всего блокчейна. Чтобы при гамма-распределении выходы не выбирались из каких-либо блоков, моложе десяти, вычисляется [указатель end pointer](https://github.com/monero-project/monero/blob/35e0a968bde4644a86f6f455b1a50ca25398fa15/src/wallet/wallet2.cpp#L970), который ограничивает информацию блокчейна, рассматриваемую при гамма-распределении. Таким образом, при расчёте не учитываются последние 10 блоков (время разблокировки блока). Однако, поскольку вновь созданная транзакция попадает не в текущий старший блок, а в следующий, будущий блок, самая последняя информация, учитываемая во время создания транзакции, на самом деле на 11 блоков старше будущего блока (в котором якобы будет находиться новая транзакция).

Тем не менее, кошельки по-прежнему будут создавать транзакции с принадлежащими им участниками кольца, возраст которых составляет ровно 10 блоков. Если все кошельки будут придерживаться этой ошибочной логики, то участник кольца, возраст которого составляет 10 блоков, появится в транзакции только в том случае, если он является реально расходуемым выходом. Такая эвристика будет губительна для анонимности отправителей реальных выходов, возраст которых составляет 10 блоков.

Ошибка была исправлена в PR [#8794](https://github.com/monero-project/monero/pull/8794).

_**Эмпирический анализ**_

![01](/img/copyright/articles/2023-05-23-post-mortem-of-10-block-old-decoy-selection-bug-2023/01.png)  

На графике, приведённом выше, показано, сколько участников кольца возрастом 10 блоков появлялось в транзакциях с течением времени по сравнению с участниками кольца возрастом 11 блоков. Синей линией обозначен процент участников кольца в транзакциях в блокчейне, возраст которых составляет ровно 10 блоков, а жёлтой — процент участников кольца возрастом 11 блоков. Пунктирная зеленая линия обозначает соотношение между этими двумя значениями с течением времени. Есть ещё несколько интересных паттернов, но наиболее значимым с точки зрения проведённого анализа является всплеск использования участников кольца возрастом 10 блоков после выхода версии v0.18.2.2, первой версии кошелька с исправленной ошибкой, а также увеличение соотношения между этими двумя возрастами. Поскольку в настоящее время у основной команды разработчиков нет возможности отслеживать  использование версии кошелька, равно как у них нет и доступных данных о соотношении пользователей, использующих старые и новые кошельки, которые помогли бы установить корреляцию данных о старых участниках кольца возрастом 10 блоков. Однако столь заметный всплеск использования старых участников кольца возрастом 10 блоков именно в момент реализации исправленной версии позволяет предположить, что это исправление статистически изменило процесс выбора ложных выходов в пользу более новых участников кольца.

Также, к счастью, данные свидетельствуют о более сложной истории, чем рассматриваемый нами наихудший эвристический сценарий. До исправления ошибки всё ещё было много случаев использования старых участников кольца возрастом 10 блоков, что, вероятно, связано с пользовательским программным обеспечением. Это делает эвристический анализ с целью деанонимизации менее эффективным, чем предполагалось изначально.

### _Заключение_

Дабы не тратить время впустую, повторю слова @j-berman из его оригинальной [аналитической статьи](https://www.getmonero.org/2021/09/20/post-mortem-of-decoy-selection-bugs.html), посвящённой ошибке, связанной с выбором ложных выходов: «всем, кто разбирается в статистике и теории вероятности, рекомендуется принять участие в обсуждении, направленном на улучшение алгоритма». Оглядываясь назад, можно предположить, что эту ошибку можно было выявить, тщательно проанализировав статистические распределения. Однако ошибка была [обнаружена случайно](https://github.com/monero-project/monero/pull/8794#issuecomment-1478585470) при попытке исправить [бесконечный цикл с проверкой условия](https://github.com/monero-project/monero/pull/8794#issue-1633821949) при выборе ложных выходов. Это подводит меня ко второму моменту, который я считаю важным, но, может быть, и несколько спорным: код выбора ложных выходов в wallet2 должен быть полностью переписан. Функция wallet2::get_outs имеет длину [более 600](https://github.com/monero-project/monero/blob/94e67bf96bbc010241f29ada6abc89f49a81759c/src/wallet/wallet2.cpp#L8165) строк, мало комментариев и была протестирована ненадлежащим образом. Учитывая, насколько важен выбор ложных выходов с точки зрения модели обеспечения приватности Monero, код, который фактически реализует эту функцию в большинстве кошельков, является некачественным. В настоящее время ведётся множество замечательных дискуссий, связанных с выбором ложных выходов, в частности, предлагается [выбирать только выходы, не являющиеся coinbase-выходами, при построении не являющихся coinbase транзакций, строить консолидированные coinbase-транзакции, реализовать механизм биннинга колец и так далее](https://github.com/monero-project/research-lab/issues/84). И хотя проект Monero всегда был ориентирован на будущее, он также был более обоснованным и проверенным на практике по сравнению с другими экспериментальными монетами, обеспечивающими приватность своих пользователей. Такое положение вещей сохраняется исключительно благодаря упорному труду и преданности членов сообщества, которые следят за кодом и совершенствуют его. Присоединяйтесь к каналам #monero-research-lab и #monero-dev в IRC/Matrix, участвуйте в дискуссиях и больше общайтесь с другими членами сообщества. Вы также можете присоединиться к соответствующим [рабочим группам Monero](https://www.getmonero.org/community/workgroups/).

---

_Источник: [[Vulnerability Disclosure] Post-Mortem of 10-Block-Old Decoy Selection Bug 2023 #8872](https://github.com/monero-project/monero/issues/8872)_

_Перевод: [Mr. Pickles](https://t.me/v1docq47)_  
_Коррекция: [Kukima](https://t.me/Kukima)_
