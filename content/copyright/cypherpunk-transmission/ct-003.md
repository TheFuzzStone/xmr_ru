---
title: "CT-003: Обеспечение базовой защиты сервера"
date: "2022-10-31"
categories:
  - "Статьи"
  - "Cypherpunk Transmission"
tags:
  - "Cypherpunk Transmission"
thumbnail: "img/copyright/cypherpunk-transmission/ct-003.png"
lead: "Это третий отчёт из новой серии 'Cypherpunk Transmission'"
pager: true
toc: true
sidebar: "right"
---

## _Мотивация_

Первое, что, как правило, делают админы после регистрации готового сервера — обеспечивают его безопасность.

Несмотря на существование множества продвинутых технологий и методов повышения уровня безопасности нового сервера от различных угроз, в настоящем руководстве мы рассмотрим только базовые.

## _Предварительные условия_

- Наличие ssh доступа к VPS (на базе debian) с машины GNU/Linux.
- Базовый опыт работы с консолью и текстовым редактором nano.
- Примерно час свободного времени.

## _Компиляция Monero CLI_

Попрактикуемся, скомпилировав на базе исходного кода официальный CLI-кошелёк Monero.

### 1. _Добавление нового пользователя_

_Примечание: если вы не подсоединены, введите в консоли команду `ssh root@server_ip`. Замените server_ip IP-адресом своего VPS_.

Во избежание использования корневого аккаунта на постоянной основе, сначала необходимо добавить нового пользователя, наделив его правами администратора:

```
adduser newuser
```

Создайте сложный пароль и нажмите Enter, чтобы пропустить опциональные поля:

```
usermod -aG sudo newuser
```

### 2. _Установка брандмауэра_

С помощью apt обновите и установите основной брандмауэр:

```
apt update
apt install ufw
```

Установите права, доступные по умолчанию:

```
ufw default deny incoming
ufw default allow outgoing
```

Подключите соединения ssh и включите брандмауэр:

```
ufw allow SSH
```

Проверьте состояние:

```
ufw status verbose
```

Продолжайте только при наличии на выходе следующей строки:

```
To             Action      From
--             ------      ----
22/tcp (SSH)   ALLOW IN    Anywhere
```

Включите брандмауэр:

```
ufw enable
```

_Примечание: позднее, возможно, вам придётся изменить настройки брандмауэра, чтобы он пропускал трафик других используемых вами сервисов. В случае с Nginx, например, для этого используется команда `sudo ufw allow 'Nginx Full'`_.
Теперь соединение с сервером может быть закрыто с помощью команды `exit`.

### 3. _Усиление SSH_

#### 3.1 _Конфигурация клиента_

На своей локальной машине откройте файл `ssh_config`:

```
sudo nano /etc/ssh/ssh_config
```

Добавьте или измените следующие строки, чтобы разрешить аутентификацию публичного ключа, отключить IPv6 с целью уменьшения поверхности атаки, а также разрешить использование сильных методов шифрования, кодов, обеспечивающих целостность сообщений и доступных алгоритмов обмена ключами:

```
PubkeyAuthentication yes
AddressFamily inet
StrictHostKeyChecking ask
Ciphers chacha20-poly1305@openssh.com
MACs hmac-sha2-512-etm@openssh.com
KexAlgorithms curve25519-sha256
```

Сохраните файл, используя `CTRL+X` > `Y` и нажмите Enter.

#### 3.2 _Конфигурация сервера_

В целях резервирования откройте два окна/вкладки с консолью и установите два отдельных SSH-соединения с сервером:

```
ssh root@server_ip
```

Перезапустите демон sshd:

```
systemctl restart sshd
```

Если оба соединения останутся активными, попробуйте открыть третье окно с консолью и протестируйте новые соединения:

```
ssh root@server_ip
```

Если всё работает, как и ожидалось, можно продолжить.

В любой из консолей создайте резервную копию оригинального файла конфигурации SSH:

```
cp /etc/ssh/sshd_config /etc/ssh/sshd_config_backup
```

Затем откройте файл `sshd_config`:

```
nano /etc/ssh/sshd_config
```

Добавьте или измените следующие строки, чтобы активировать дополнительную защиту SSH v2 от известных угроз, отключить IPv6, доступ к корневой директории / отправке данных, оставить доступ только для конкретного пользователя `newuser`, и дать возможность использовать самые сильные из доступных методы шифрования и алгоритмы:

```
Protocol 2
AddressFamily inet
PermitRootLogin prohibit-password
PasswordAuthentication no
AllowUsers newuser
Ciphers chacha20-poly1305@openssh.com
MACs hmac-sha2-512-etm@openssh.com
KexAlgorithms curve25519-sha256
```

_Примечание: следует заменить `newuser` фактическим именем пользователя, которое использовалось на первом этапе_.

_Примечание: для получения списка доступных методов шифрования и алгоритмов, используйте команды `ssh -Q cipher`, `ssh -Q mac` и `ssh -Q kex`_.

Вы также можете изменить используемый по умолчанию порт прослушивания SSH-демона с 22 на какой-то другой во избежание сканирования открытых портов:

```
Port 3489
```

Примечание: если вы измените ssh-порт, используемый по умолчанию, вам придётся обновить правила ufw. Например: `ufw allow 3489`. Соединение устанавливается с помощью `ssh newuser@server_ip -p 3489`.

Сохраните файл, используя `CTRL+X` > `Y` и нажмите Enter.

#### 3.3 _Конфигурация клиента_

Перезапустите демон sshd:

```
systemctl restart sshd
```

Откройте ещё одну вкладку/окно с консолью и попытайтесь установить SSH с сервером:

```
ssh newuser@server_ip
```

Если это не сработает, проверьте конфигурацию на наличие ошибок, воспользовавшись другой консолью, а затем попытайтесь снова.

Если всё пройдёт успешно, вы сможете установить ssh с сервером для `newuser`, а также устанавливать любое необходимое вам программное обеспечение.

## _Примечания_

- Во избежание атак методом перебора для регистрации в системе используйте сложные и случайные пароли.
- Генерируйте и используйте сильные ключи SSH, защищённые фразами-паролями.
- Регулярно обновляйте систему. Процесс можно автоматизировать с помощью демона _cron_.
- Дополнительно установите _Fail2Ban_, чтобы отслеживать системный журнал и обеспечить защиту от DDoS атак.

Вот и всё руководство по обеспечению базовой защиты сервера. Если у вас возникнут какие-либо проблемы, свяжитесь со мной. Удачи!

---

## _Обратная связь_

Если эта статья показалась вам полезной, заинтересовала вас, дайте мне знать, и я сделаю всё возможное, чтобы публиковать подобные отчёты Cypherpunk Transmission каждый (второй?) понедельник.

Вопросы, правки и предложения приветствуются.

Благодарю gnuteardrops из [monero.graphics](https://monero.graphics/) за потрясающую графику xkcd. Работа и шрифт xkcd лицензированы в соответствии с [CC BY-NC 3.0](https://github.com/ipython/xkcd-font/blob/master/LICENSE).

---

_Источник: [CT-003: Basic server security](https://monero.observer/cypherpunk-transmission-003-basic-server-security/)_

_Перевод: [Mr. Pickles](https://t.me/v1docq47)_  
_Коррекция: [Kukima](https://t.me/Kukima)_
